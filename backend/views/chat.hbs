<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wild West Chat with Socket.io</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        /* Chat container */
        #chatContainer {
            display: flex;
            flex-direction: column;
            height: 50vh;
            max-width: 600px;
            margin: 0 auto;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }

        /* Messages area */
        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #f9f9f9;
        }

        /* Message bubbles */
        .message {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message .meta {
            font-size: 0.8em;
        }

        /* Input area */
        #inputContainer {
            display: flex;
            padding: 10px;
            background-color: #eee;
        }

        #messageInput {
            flex: 1;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-right: 5px;
        }

        #sendMessageBtn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }

        #sendMessageBtn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    {{> header title="Chatroom"}}
    <div id="chatContainer">
        <div id="messages"></div>
        <div id="inputContainer" method="POST" action="/chat">
            <input type="text" id="messageInput" name="message" placeholder="Type your message..." />
            <button id="sendMessageBtn">Send</button>
        </div>
    </div>
    
    <div id="status">Not connected</div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script>
        // First populate the past chats
        const chats = {{{ chats }}};
        const list = document.getElementById("dynamic-list");

        chats.forEach(item => {
            const messagesContainer = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');
            msgDiv.style.border = `1px solid ${item.color}`;
            msgDiv.style.color = item.color;

            const metaDiv = document.createElement('div');
            metaDiv.classList.add('meta');
            metaDiv.textContent = `${item.author} • ${item.timeposted}`;
            metaDiv.style.color = item.color;

            const textDiv = document.createElement('div');
            textDiv.textContent = data.message;

            msgDiv.appendChild(metaDiv);
            msgDiv.appendChild(textDiv);
            messagesContainer.appendChild(msgDiv);
        });

        // Connect to Socket.IO with credentials
        // Important: Set withCredentials to true so cookies are sent
        let socket = null;
        socket = io('https://keengreenmachine.org', { withCredentials: true });
        console.log('Connect button clicked');
        console.log('Socket:', socket);
        socket.on('connected', (data) => {
            const status = document.getElementById('status');
            status.textContent = data.message;
        });
        
        socket.on('error', (error) => {
            document.getElementById('status').textContent = 'Error: ' + error.message;
        });
        
        socket.on('userInfo', (data) => {
            document.getElementById('messages').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        });
        
        socket.on('message', (data) => {
            const messagesContainer = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');
            msgDiv.style.border = `1px solid ${data.namecolor}`;
            msgDiv.style.color = data.namecolor;

            const metaDiv = document.createElement('div');
            metaDiv.classList.add('meta');
            const time = new Date().toISOString();
            metaDiv.textContent = `${data.displayname} • ${time}`;
            metaDiv.style.color = data.namecolor;

            const textDiv = document.createElement('div');
            textDiv.textContent = data.message;

            msgDiv.appendChild(metaDiv);
            msgDiv.appendChild(textDiv);
            messagesContainer.appendChild(msgDiv);
        });
        
        // Send message
        document.getElementById('sendMessageBtn').addEventListener('click', () => {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return; // don't send empty messages

            if (socket) {
                socket.emit('sendMessage', { message });
            }
            input.value = ''; // clear input after sending
        });
    </script>
    {{> footer }}
</body>
</html>
